#!/bin/bash
#
# Pre-commit hook to prevent committing cache files and other unwanted files
#

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Patterns to block
BLOCKED_PATTERNS=(
    "__pycache__"
    "\.pyc$"
    "\.pyo$"
    "\.pyd$"
    "\.py[cod]$"
    "\.tmp$"
    "\.log$"
    "\.env$"
    "\.env\.local$"
    "\.env\..*\.local$"
    "venv/"
    "\.venv/"
    "vector_store/"
    "models/.*\.(gguf|bin|safetensors|pt|pth)$"
)

# Get list of files staged for commit
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

# Check each staged file against blocked patterns
BLOCKED_FILES=()
for file in $STAGED_FILES; do
    for pattern in "${BLOCKED_PATTERNS[@]}"; do
        if echo "$file" | grep -qE "$pattern"; then
            BLOCKED_FILES+=("$file")
            break
        fi
    done
done

# If blocked files found, prevent commit
if [ ${#BLOCKED_FILES[@]} -gt 0 ]; then
    echo -e "${RED}❌ ERROR: Attempted to commit blocked files!${NC}"
    echo -e "${YELLOW}The following files should not be committed:${NC}\n"
    for file in "${BLOCKED_FILES[@]}"; do
        echo -e "  ${RED}✗${NC} $file"
    done
    echo -e "\n${YELLOW}These files are ignored by .gitignore for a reason.${NC}"
    echo -e "${YELLOW}Please remove them from staging:${NC}"
    echo -e "  ${GREEN}git reset HEAD <file>${NC}"
    echo -e "\n${YELLOW}Or unstage all blocked files:${NC}"
    echo -e "  ${GREEN}git reset HEAD${NC}"
    exit 1
fi

exit 0
